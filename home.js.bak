import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

/* -------------------------------------------------
   FIREBASE INIT
------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCHeYdFLldJujCUxnGZ8HWqtLtSwQwF5aw",
  authDomain: "dresses-95f9a.firebaseapp.com",
  projectId: "dresses-95f9a.firebaseapp.com",
  storageBucket: "dresses-95f9a.firebasestorage.app",
  messagingSenderId: "525890814996",
  appId: "1:525890814996:web:5dcca98f67a0d6fc6fd301"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

/* -------------------------------------------------
   AUTH GUARD
------------------------------------------------- */
onAuthStateChanged(auth, async (user) => {
  if (!user || !user.emailVerified) {
    window.location.href = "index.html";
    return;
  }

  await loadCredits();
  await loadShop(); // default view
});

/* -------------------------------------------------
   LOGOUT
------------------------------------------------- */
document.getElementById("logout").onclick = async () => {
  await signOut(auth);
  window.location.href = "index.html";
};

/* -------------------------------------------------
   HELPERS
------------------------------------------------- */
async function authFetch(url, options = {}) {
  const token = await auth.currentUser.getIdToken();
  return fetch(url, {
    ...options,
    headers: {
      ...(options.headers || {}),
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json"
    }
  });
}

/* -------------------------------------------------
   DASHBOARD LOADERS
------------------------------------------------- */
async function loadCredits() {
  const res = await authFetch("/api/me");
  const data = await res.json();

  document.getElementById("credits").innerText =
    `Credits: ${data.credits}`;
}

async function loadShop() {
  const res = await authFetch("/api/marketplace");
  const data = await res.json();
  renderShopItems(data.items);
}

async function loadMyCloset() {
  const res = await authFetch("/api/my-items");
  const data = await res.json();
  renderMyItems(data.items);
}

/* -------------------------------------------------
   RENDERING
------------------------------------------------- */
function renderShopItems(items) {
  const grid = document.getElementById("itemsGrid");
  grid.innerHTML = "";

  if (!items.length) {
    grid.innerHTML = "<p>No items in marketplace.</p>";
    return;
  }

  items.forEach(item => {
    const div = document.createElement("div");
    div.innerHTML = `
      <h4>${item.title}</h4>
      ${item.imageUrl ? `<img src="${item.imageUrl}" width="120">` : ""}
      <p>Size: ${item.size}</p>
      <p>${item.priceCredits} credits</p>
      <button onclick="viewItem(${item.id})">View</button>
    `;
    grid.appendChild(div);
  });
}

function renderMyItems(items) {
  const grid = document.getElementById("itemsGrid");
  grid.innerHTML = "";

  if (!items.length) {
    grid.innerHTML = "<p>You have not added any items.</p>";
    return;
  }

  items.forEach(item => {
    const div = document.createElement("div");
    div.innerHTML = `
      <h4>${item.title}</h4>
      ${item.imageUrl ? `<img src="${item.imageUrl}" width="120">` : ""}
      <p>Size: ${item.size}</p>
      <p>${item.priceCredits} credits</p>
      <button onclick="deleteItem(${item.id})">Delete</button>
    `;
    grid.appendChild(div);
  });
}

/* -------------------------------------------------
   DELETE ITEM
------------------------------------------------- */
async function deleteItem(id) {
  await authFetch(`/api/items/${id}`, { method: "DELETE" });
  loadMyCloset();
}

/* -------------------------------------------------
   ADD ITEM
------------------------------------------------- */
function loadAddItem() {
  document.getElementById("itemsGrid").innerHTML = `
    <h3>Add Item</h3>
    <input id="title" placeholder="Title" />
    <input id="size" placeholder="Size" />
    <input id="price" type="number" placeholder="Credits" />
    <input id="imageUrl" placeholder="Image URL (optional)" />
    <button id="submit">Submit</button>
  `;

  document.getElementById("submit").onclick = submitItem;
}

async function submitItem() {
  await authFetch("/api/items", {
    method: "POST",
    body: JSON.stringify({
      title: title.value,
      size: size.value,
      priceCredits: Number(price.value),
      imageUrl: imageUrl.value
    })
  });

  loadMyCloset();
}

/* -------------------------------------------------
   NAVIGATION
------------------------------------------------- */
document.querySelectorAll("nav button[data-view]").forEach(btn => {
  btn.onclick = () => {
    if (btn.dataset.view === "shop") loadShop();
    if (btn.dataset.view === "closet") loadMyCloset();
    if (btn.dataset.view === "credits") loadCreditsView();
    if (btn.dataset.view === "add") loadAddItem();
  };
});

function loadCreditsView() {
  document.getElementById("itemsGrid").innerHTML =
    "<p>Your current credits are shown in the header.</p>";
}

/* -------------------------------------------------
   PLACEHOLDER (NEXT STEP)
------------------------------------------------- */
function viewItem(id) {
  // next step â†’ item.html?id=123
  alert("Item detail page coming next.");
}
